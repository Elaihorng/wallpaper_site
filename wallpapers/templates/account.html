{% extends 'base.html' %}

{% block content %}
<div class="max-w-lg mx-auto mt-8 px-4">
  <div class="bg-white shadow-xl rounded-3xl border border-gray-100 overflow-hidden">
    <div class="p-6 flex items-center gap-4">
      <!-- avatar -->
      <div class="flex-shrink-0">
        <div class="h-16 w-16 rounded-full bg-gradient-to-tr from-indigo-500 to-rose-400 flex items-center justify-center text-white text-xl font-semibold">
          {{ request.user.username|slice:":1"|upper }}
        </div>
      </div>

      <div class="flex-1">
        <h1 class="text-2xl font-semibold leading-tight">{{ request.user.get_full_name|default:request.user.username }}</h1>
        <p class="text-sm text-gray-500 mt-1">Member since {{ request.user.date_joined|date:"F j, Y" }}</p>
      </div>

      <div class="text-right">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                     {% if request.user.user_type == 'pro' %} bg-emerald-100 text-emerald-800
                     {% elif request.user.user_type == 'basic' %} bg-amber-100 text-amber-800
                     {% else %} bg-gray-100 text-gray-700 {% endif %}">
          {{ request.user.user_type|capfirst }}
        </span>
      </div>
    </div>

    <div class="border-t border-gray-100 p-6">
      {% if subscription and subscription.status == 'active' %}
        <div class="flex items-center justify-between gap-4">
          <div>
            <p class="text-sm text-gray-500">Subscription</p>
            <p class="text-lg font-semibold text-gray-800 mt-1">{{ subscription.plan|capfirst }}</p>
            <p class="text-sm text-gray-500 mt-1">
              Until:
            <span class="font-medium text-gray-700">
            {% if subscription.current_period_end %}
                {{ subscription.current_period_end|date:"F j, Y" }}
            {% elif subscription.status == 'active' %}
                Renewal pendingâ€¦
            {% else %}
                N/A
            {% endif %}
            </span>
            </p>
          </div>

          <div class="text-right space-y-2">
            {% if subscription.plan == 'basic' %}
              <form action="{% url 'wallpapers:create_checkout_session' %}" method="POST" class="flex">
                {% csrf_token %}
                <input type="hidden" name="plan" value="pro">
                <button type="submit"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-sm font-medium shadow hover:opacity-95 active:scale-[0.99]">
                  <!-- upgrade icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 8h10M7 12h8m-8 4h6" />
                  </svg>
                  Upgrade to Pro
                </button>
              </form>
            {% endif %}

            <form action="{% url 'wallpapers:cancel_subscription' %}" method="POST" onsubmit="return confirmUnsubscribe(this);" class="">
              {% csrf_token %}
              <button type="submit"
                      class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg border border-red-200 text-red-700 text-sm font-medium hover:bg-red-50 active:scale-[0.99]">
                <!-- unsubscribe icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4m-7 4h10" />
                </svg>
                Unsubscribe
              </button>
            </form>
          </div>
        </div>

      {% else %}
        <div class="text-center space-y-4">
          <p class="text-lg font-semibold text-gray-800">No Active Subscription</p>
          <p class="text-sm text-gray-500">Subscribe to unlock premium wallpapers and extra features.</p>

          <a href="{% url 'wallpapers:subscribe_page' %}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white font-medium shadow hover:opacity-95">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            Subscribe Now
          </a>
        </div>
      {% endif %}
    </div>

    <div class="border-t border-gray-100 p-4 bg-gray-50">
      <div class="text-sm text-gray-600">
        <p class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A9 9 0 1118.364 4.56" />
          </svg>
          Account email: <span class="font-medium text-gray-800 ml-1">{{ request.user.email }}</span>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Centered Unsubscribe Modal -->
<div id="unsubscribeModal"
     class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 
            flex items-center justify-center">   <!-- THIS LINE CENTERS IT -->
  <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-lg">
    <h2 class="text-lg font-semibold mb-2">Unsubscribe?</h2>
    <p class="text-sm text-gray-600 mb-6">
      Are you sure you want to unsubscribe? You will lose access to premium content at the end of your period.
    </p>

    <div class="flex justify-end gap-3">
      <button type="button" onclick="closeModal()"
              class="px-4 py-2 rounded-lg bg-gray-100 text-sm font-medium hover:bg-gray-200">
        Cancel
      </button>

      <button type="button" id="confirmUnsubscribeBtn" onclick="submitPendingForm()"
              class="px-4 py-2 rounded-lg bg-red-600 text-white text-sm font-medium hover:opacity-95">
        Yes, unsubscribe
      </button>
    </div>
  </div>
</div>

<script>
  // Keep a reference to the form that triggered the modal.
  let pendingForm = null;

  // Called from form onsubmit: confirmUnsubscribe(this)
  function confirmUnsubscribe(form) {
    // store the form so we can submit it if the user confirms
    pendingForm = form;

    // show modal
    const modal = document.getElementById('unsubscribeModal');
    modal.classList.remove('hidden');

    // optional: lock body scroll
    document.documentElement.classList.add('overflow-hidden');

    // focus confirm button for keyboard users
    const confirmBtn = document.getElementById('confirmUnsubscribeBtn');
    if (confirmBtn) confirmBtn.focus();

    // prevent immediate submission
    return false;
  }

  function closeModal() {
    const modal = document.getElementById('unsubscribeModal');
    modal.classList.add('hidden');
    document.documentElement.classList.remove('overflow-hidden');
    pendingForm = null;
  }

  function submitPendingForm() {
    if (!pendingForm) return closeModal();

    // submit the stored form
    pendingForm.submit();

    // clear reference and hide modal (submission will navigate away)
    pendingForm = null;
    closeModal();
  }

  // Close modal when pressing Escape
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('unsubscribeModal');
      if (modal && !modal.classList.contains('hidden')) closeModal();
    }
  });

  // optional: click backdrop to close
  document.getElementById('unsubscribeModal').addEventListener('click', function (e) {
    // only close if clicking the backdrop, not the dialog itself
    if (e.target === this) closeModal();
  });
</script>

{% endblock %}
