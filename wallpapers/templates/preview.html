{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="max-w-3xl mx-auto mt-6 px-4">
  <a href="{% url 'wallpapers:home' %}"
     class="inline-flex items-center mb-4 p-2 rounded-full hover:bg-gray-100 transition"
     aria-label="Back to home">
    <svg xmlns="http://www.w3.org/2000/svg"
         class="h-6 w-6 text-gray-700"
         fill="none"
         viewBox="0 0 24 24"
         stroke="currentColor"
         stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
    </svg>
  </a>

  <h2 class="text-2xl font-bold mb-4">{{ w.title }}</h2>

  <!-- Preview card -->
  <div class="relative rounded-lg overflow-hidden shadow-lg p-3 bg-white">
    {% if w.is_premium %}
      <span class="absolute top-3 right-3 bg-yellow-300 text-black text-xs font-semibold px-3 py-1 rounded-md shadow-lg z-20">
        Premium
      </span>
    {% else %}
      <span class="absolute top-3 right-3 bg-green-100 text-green-800 text-xs font-semibold px-3 py-1 rounded-md shadow z-20">
        Free
      </span>
    {% endif %}

    <img
      src="{{ w.image.url }}"
      alt="{{ w.title }}"
      class="w-full h-[60vh] sm:h-[70vh] md:h-[80vh] object-cover rounded"
      loading="eager"
      draggable="false"
      oncontextmenu="return false;"
    />

    <div class="mt-4 flex items-center justify-between gap-4">
      <div>
        {% comment %} Download / Subscribe buttons {% endcomment %}
        {% with sub=request.user.subscription %}
          {% if w.is_premium %}
            {% if request.user.is_authenticated and sub and sub.status == 'active' %}
              <!-- ACTIVE SUBSCRIBER (basic or pro) -->
              <a href="{% url 'wallpapers:download_wallpaper' w.pk %}"
                 class="inline-block px-4 py-2 bg-blue-600 text-white rounded shadow">Download</a>

              {% if sub.plan == 'basic' %}
                <p class="text-xs text-gray-600 mt-1">
                  Basic remaining: {{ sub.downloads_remaining }}
                </p>
              {% endif %}

            {% elif request.user.is_authenticated %}
              <!-- Logged in but no active sub -->
              <a href="{% url 'wallpapers:subscribe_page' %}"
                 class="inline-block px-4 py-2 bg-amber-500 text-white rounded">Subscribe to Download</a>

            {% else %}
              <!-- Guest -->
              <a href="{% url 'wallpapers:login' %}?next={{ request.path }}"
                 class="inline-block px-4 py-2 bg-blue-600 text-white rounded">Login to Download</a>
            {% endif %}
          {% else %}
            <!-- Free wallpaper -->
            {% if request.user.is_authenticated %}
              <a href="{% url 'wallpapers:download_wallpaper' w.pk %}"
                 class="inline-block px-4 py-2 bg-blue-600 text-white rounded">Download</a>
            {% else %}
              <a href="{% url 'wallpapers:login' %}?next={{ request.path }}"
                 class="inline-block px-4 py-2 bg-blue-600 text-white rounded">Login to Download</a>
            {% endif %}
          {% endif %}
        {% endwith %}
      </div>

      <div class="text-sm text-gray-600 text-right">
        {% comment %} <p>Uploaded by: <span class="font-medium text-gray-800">{{ w.uploaded_by.username|default:"Unknown" }}</span></p> {% endcomment %}
        <p class="text-xs mt-1">{{ w.created_at|date:"F j, Y" }}</p>
      </div>
    </div>

    <!-- ----------- FIXED OVERLAY ----------- -->
    {% with sub=request.user.subscription %}
      {% if w.is_premium %}
        {% if request.user.is_authenticated and request.user.user_type == 'pro' and request.user.subscription and request.user.subscription.status == 'active' %}
          <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="backdrop-blur-md bg-black/50 text-white p-6 rounded-lg text-center max-w-lg pointer-events-auto">

              <p class="text-lg mb-4">Premium image — subscribe to download</p>

              {% if request.user.is_authenticated %}
                <a href="{% url 'wallpapers:subscribe_page' %}"
                   class="px-4 py-2 rounded bg-emerald-600">Subscribe</a>
              {% else %}
                <div class="flex items-center justify-center gap-3">
                  <a href="{% url 'wallpapers:login' %}?next={{ request.path }}"
                     class="px-4 py-2 rounded bg-blue-600 text-white">Login</a>
                  <a href="{% url 'wallpapers:register' %}"
                     class="px-4 py-2 rounded bg-amber-500">Register</a>
                </div>
              {% endif %}

            </div>
          </div>
        {% endif %}
      {% endif %}
    {% endwith %}
    <!-- -------- END OVERLAY FIX -------- -->

  </div>

  <!-- Actions row -->
  <div class="mt-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-2">
      <button class="px-3 py-1 bg-white border rounded text-sm shadow-sm hover:bg-gray-50">❤️ Favorite</button>
      <button id="shareBtn" class="px-3 py-1 bg-white border rounded text-sm shadow-sm hover:bg-gray-50">Share</button>
    </div>
  </div>

  <!-- Suggested thumbnails -->
  <section class="mt-10">
    <h2 class="text-lg font-semibold mb-4">Suggested for you</h2>

    <div class="flex gap-4 overflow-x-auto pb-4">
      {% for s in suggested %}
        <a href="{% url 'wallpapers:wallpaper_preview' s.pk %}"
           class="flex-shrink-0 w-48 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition">
          <div class="relative w-full" style="padding-top: 60%;">
            <img src="{{ s.image.url }}" class="absolute inset-0 w-full h-full object-cover" alt="{{ s.title }}" />
          </div>
        </a>
      {% empty %}
        <p class="text-gray-500">No suggestions available.</p>
      {% endfor %}
    </div>
  </section>
</div>

<script>
  document.querySelectorAll('img').forEach(img => {
    img.addEventListener('contextmenu', e => e.preventDefault());
    img.setAttribute('draggable', 'false');
  });

  document.getElementById("shareBtn").addEventListener("click", function () {
    const shareData = {
      title: "{{ w.title|escapejs }}",
      text: "Check out this wallpaper!",
      url: window.location.href
    };

    if (navigator.share) {
      navigator.share(shareData).catch(err => console.log("Share failed:", err));
    } else if (navigator.clipboard) {
      navigator.clipboard.writeText(window.location.href)
        .then(() => alert("Link copied to clipboard!"))
        .catch(() => alert("Unable to copy link."));
    } else {
      prompt("Copy this link:", window.location.href);
    }
  });
</script>

{% endblock %}
