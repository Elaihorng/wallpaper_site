{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="max-w-3xl mx-auto mt-6 px-4">
  <a href="{% url 'wallpapers:home' %}"
     class="inline-flex items-center mb-4 p-2 rounded-full hover:bg-gray-100 transition"
     aria-label="Back to home">
    <svg xmlns="http://www.w3.org/2000/svg"
         class="h-6 w-6 text-gray-700"
         fill="none"
         viewBox="0 0 24 24"
         stroke="currentColor"
         stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
    </svg>
  </a>

  <h2 class="text-2xl font-bold mb-4">{{ w.title }}</h2>
  <div id="centerPopup"
     class="fixed inset-0 z-50 hidden bg-black bg-opacity-40 flex items-center justify-center">
  
    <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm text-center">
      <p id="popupMessage" class="text-gray-800 text-base font-medium mb-6"></p>

      <button onclick="closeCenterPopup()"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:opacity-90">
        OK
      </button>
    </div>
  </div>
  <!-- Preview card -->
  <div class="relative rounded-lg overflow-hidden shadow-lg p-3 bg-white">
    {% if w.is_premium %}
      <span class="absolute top-3 right-3 bg-yellow-300 text-black text-xs font-semibold px-3 py-1 rounded-md shadow-lg z-20">
        Premium
      </span>
    {% else %}
      <span class="absolute top-3 right-3 bg-green-100 text-green-800 text-xs font-semibold px-3 py-1 rounded-md shadow z-20">
        Free
      </span>
    {% endif %}

    <img
      src="{{ w.image.url }}"
      alt="{{ w.title }}"
      class="w-full h-[60vh] sm:h-[70vh] md:h-[80vh] object-cover rounded"
      loading="eager"
      draggable="false"
      oncontextmenu="return false;"
    />

    <div class="mt-4 flex items-center justify-between gap-4">
      <div>
        {# Download / Subscribe buttons #}
        {% if request.user.is_authenticated %}
          {% with sub=request.user.subscription %}
            {% if w.is_premium %}
              {% if sub and sub.status == 'active' %}
                <!-- ACTIVE SUBSCRIBER (basic or pro) -->
                <button id="downloadBtn" data-pk="{{ w.pk }}" class="inline-block px-4 py-2 bg-blue-600 text-white rounded shadow">
                  Download
                </button>


                {% if sub.plan == 'basic' %}
                  <p class="text-xs text-gray-600 mt-1">
                    Basic remaining: <span id="basic-remaining">{{ sub.downloads_remaining }}</span>
                  </p>
                {% endif %}

              {% else %}
                <!-- Logged in but no active sub -->
                <a href="{% url 'wallpapers:subscribe_page' %}"
                   class="inline-block px-4 py-2 bg-amber-500 text-white rounded">Subscribe to Download</a>
              {% endif %}
            {% else %}
              <!-- Free wallpaper for logged in user -->
              <a href="{% url 'wallpapers:download_wallpaper' w.pk %}"
                 class="inline-block px-4 py-2 bg-blue-600 text-white rounded">Download</a>
            {% endif %}
          {% endwith %}
        {% else %}
          {# guest user #}
          {% if w.is_premium %}
            <a href="{% url 'wallpapers:login' %}?next={{ request.path }}"
               class="inline-block px-4 py-2 bg-blue-600 text-white rounded">Login to Download</a>
          {% else %}
            <a href="{% url 'wallpapers:login' %}?next={{ request.path }}"
               class="inline-block px-4 py-2 bg-blue-600 text-white rounded">Login to Download</a>
          {% endif %}
        {% endif %}
      </div>

      <div class="text-sm text-gray-600 text-right">
        <p class="text-xs mt-1">{{ w.created_at|date:"F j, Y" }}</p>
      </div>
    </div>

    <!-- ----------- FIXED OVERLAY: show when NOT an active subscriber ----------- -->
    {% if w.is_premium %}
      {% if not request.user.is_authenticated %}
        <!-- guest: prompt login/register -->
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="backdrop-blur-md bg-black/50 text-white p-6 rounded-lg text-center max-w-lg">
            <p class="text-lg mb-4">Premium image — subscribe to download</p>
            <div class="flex items-center justify-center gap-3">
              <a href="{% url 'wallpapers:login' %}?next={{ request.path }}"
                 class="px-4 py-2 rounded bg-blue-600 text-white">Login</a>
              <a href="{% url 'wallpapers:register' %}"
                 class="px-4 py-2 rounded bg-amber-500">Register</a>
            </div>
          </div>
        </div>

      {% else %}
        {% with sub=request.user.subscription %}
          {% if not sub or sub.status != 'active' %}
            <!-- logged-in but not active subscriber: prompt subscribe -->
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="backdrop-blur-md bg-black/50 text-white p-6 rounded-lg text-center max-w-lg">
                <p class="text-lg mb-4">Premium image — subscribe to download</p>
                <a href="{% url 'wallpapers:subscribe_page' %}"
                   class="px-4 py-2 rounded bg-emerald-600 text-white inline-block">Subscribe</a>
              </div>
            </div>
          {% endif %}
        {% endwith %}
      {% endif %}
    {% endif %}
    <!-- -------- END OVERLAY -------- -->

  </div>

  <!-- Actions row -->
  <div class="mt-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-2">
      <button class="px-3 py-1 bg-white border rounded text-sm shadow-sm hover:bg-gray-50">❤️ Favorite</button>
      <button id="shareBtn" class="px-3 py-1 bg-white border rounded text-sm shadow-sm hover:bg-gray-50">Share</button>
    </div>
  </div>

  <!-- Suggested thumbnails -->
  <section class="mt-10">
    <h2 class="text-lg font-semibold mb-4">Suggested for you</h2>

    <div class="flex gap-4 overflow-x-auto pb-4">
      {% for s in suggested %}
        <a href="{% url 'wallpapers:wallpaper_preview' s.pk %}"
           class="flex-shrink-0 w-48 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition">
          <div class="relative w-full" style="padding-top: 60%;">
            <img src="{{ s.image.url }}" class="absolute inset-0 w-full h-full object-cover" alt="{{ s.title }}" />
          </div>
        </a>
      {% empty %}
        <p class="text-gray-500">No suggestions available.</p>
      {% endfor %}
    </div>
  </section>
</div>

<script>

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.getElementById('downloadBtn')?.addEventListener('click', async function (e) {
  e.preventDefault();
  const pk = this.dataset.pk;
  const url = "{% url 'wallpapers:initiate_download' 0 %}".replace('/0/', '/' + pk + '/');
  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Accept': 'application/json',
      },
      body: ''  // no body needed
    });

    const data = await res.json();
    if (!res.ok) {
      if (data.error === 'quota_exhausted') {
        showCenterPopup('You has Reached your limit. Upgrade to Pro to Download Unlimited.');
        return;
      } 
      else if (data.error === 'no_active_subscription') {
        showCenterPopup('No active subscription. Please subscribe.');
        setTimeout(() => {
          window.location.href = "{% url 'wallpapers:subscribe_page' %}";
        }, 1500);
      }
      else {
        showCenterPopup('Download failed.');
      }
    return;
  }

  showCenterPopup('Quota exhausted. Upgrade to Pro.');


    // update remaining count on the page
    const remEl = document.getElementById('basic-remaining');
    if (remEl && data.remaining !== undefined) remEl.textContent = data.remaining;

    // start the download
    window.location.href = data.download_url;

  } catch (err) {
    console.error(err);
    alert('Network error.');
  }
});


  document.querySelectorAll('img').forEach(img => {
    img.addEventListener('contextmenu', e => e.preventDefault());
    img.setAttribute('draggable', 'false');
  });

  document.getElementById("shareBtn").addEventListener("click", function () {
    const shareData = {
      title: "{{ w.title|escapejs }}",
      text: "Check out this wallpaper!",
      url: window.location.href
    };

    if (navigator.share) {
      navigator.share(shareData).catch(err => console.log("Share failed:", err));
    } else if (navigator.clipboard) {
      navigator.clipboard.writeText(window.location.href)
        .then(() => alert("Link copied to clipboard!"))
        .catch(() => alert("Unable to copy link."));
    } else {
      prompt("Copy this link:", window.location.href);
    }
  });

  function showCenterPopup(message) {
    document.getElementById('popupMessage').textContent = message;
    document.getElementById('centerPopup').classList.remove('hidden');
  }

  function closeCenterPopup() {
    document.getElementById('centerPopup').classList.add('hidden');
  }
</script>

{% endblock %}
